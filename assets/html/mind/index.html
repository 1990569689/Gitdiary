<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>åœ¨çº¿æ€ç»´å¯¼å›¾</title>
    <meta charset="utf-8">
    <!-- å¼•å…¥ jsMind æ ·å¼ -->
    <link type="text/css" rel="stylesheet" href="./jsmind/style/jsmind.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        
        html {
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        
        #jsmind_container {
            width: 100vw;
            height: 100vh;
            background: #ffffff;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
        }
        
        #jsmind_container .jsmind-inner {
            overflow: hidden !important;
        }
        
        #jsmind_container canvas {
            overflow: hidden !important;
        }
        
        #jsmind_container jmnodes {
            overflow: hidden !important;
        }
        
        .toolbar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            
            gap: 8px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .toolbar button, .toolbar .button {
            padding: 10px 18px;
            border: none;
            border-radius: 25px;
            background: #6c5ce7;
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            box-shadow: 0 2px 8px rgba(108, 92, 231, 0.3);
        }
        
        .toolbar button:hover, .toolbar .button:hover {
            background: #5f3dc4;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(108, 92, 231, 0.4);
        }
        
        .toolbar button:active, .toolbar .button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(108, 92, 231, 0.3);
        }
        
        /* ä¸ºä¸åŒåŠŸèƒ½çš„æŒ‰é’®è®¾ç½®ä¸åŒé¢œè‰² */
        .toolbar button:nth-child(1) { background: #00b894; box-shadow: 0 2px 8px rgba(0, 184, 148, 0.3); }
        .toolbar button:nth-child(1):hover { background: #00a085; box-shadow: 0 4px 16px rgba(0, 184, 148, 0.4); }
        
        .toolbar button:nth-child(2) { background: #e17055; box-shadow: 0 2px 8px rgba(225, 112, 85, 0.3); }
        .toolbar button:nth-child(2):hover { background: #d63031; box-shadow: 0 4px 16px rgba(225, 112, 85, 0.4); }
        
        .toolbar button:nth-child(3) { background: #fdcb6e; color: #2d3436; box-shadow: 0 2px 8px rgba(253, 203, 110, 0.3); }
        .toolbar button:nth-child(3):hover { background: #f39c12; box-shadow: 0 4px 16px rgba(253, 203, 110, 0.4); }
        
        .toolbar button:nth-child(4) { background: #74b9ff; box-shadow: 0 2px 8px rgba(116, 185, 255, 0.3); }
        .toolbar button:nth-child(4):hover { background: #0984e3; box-shadow: 0 4px 16px rgba(116, 185, 255, 0.4); }
        
        .toolbar button:nth-child(5) { background: #a29bfe; box-shadow: 0 2px 8px rgba(162, 155, 254, 0.3); }
        .toolbar button:nth-child(5):hover { background: #6c5ce7; box-shadow: 0 4px 16px rgba(162, 155, 254, 0.4); }
        
        .toolbar button:nth-child(6) { background: #fd79a8; box-shadow: 0 2px 8px rgba(253, 121, 168, 0.3); }
        .toolbar button:nth-child(6):hover { background: #e84393; box-shadow: 0 4px 16px rgba(253, 121, 168, 0.4); }
        
        .toolbar .button { background: #55a3ff; box-shadow: 0 2px 8px rgba(85, 163, 255, 0.3); }
        .toolbar .button:hover { background: #3742fa; box-shadow: 0 4px 16px rgba(85, 163, 255, 0.4); }
        
        /* éšè—æ–‡ä»¶è¾“å…¥æ¡† */
        #importFile {
            display: none;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .toolbar {
                flex-wrap: wrap;
                gap: 6px;
                padding: 10px 15px;
                top: 10px;
            }
            
            .toolbar button, .toolbar .button {
                padding: 8px 14px;
                font-size: 12px;
                min-width: 70px;
            }
        }
        
        /* æ€ç»´å¯¼å›¾èŠ‚ç‚¹æ ·å¼ä¼˜åŒ– */
        jmnode {
            border-radius: 8px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
        }
        
        /* å³é”®èœå•æ ·å¼ */
        .context-menu {
            position: fixed;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 0;
            z-index: 10000;
            display: none;
            min-width: 160px;
        }
        
        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #2d3436;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .context-menu-item:hover {
            background: rgba(108, 92, 231, 0.1);
            color: #6c5ce7;
        }
        
        .context-menu-item.disabled {
            color: #b2bec3;
            cursor: not-allowed;
        }
        
        .context-menu-item.disabled:hover {
            background: none;
            color: #b2bec3;
        }
        
        .context-menu-separator {
            height: 1px;
            background: rgba(0, 0, 0, 0.1);
            margin: 4px 0;
        }
        
        /* å›¾æ ‡æ ·å¼ */
        .menu-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }
    </style>
</head>
<body>
<!-- éšè—çš„å·¥å…·æ  -->
<div class="toolbar">
    <button onclick="addNode()">æ·»åŠ å­èŠ‚ç‚¹</button>
    <button onclick="removeNode()">åˆ é™¤èŠ‚ç‚¹</button>
    <button onclick="editNode()">ç¼–è¾‘èŠ‚ç‚¹</button>
    <button onclick="saveDataToLocal()">ä¿å­˜</button>
    <button onclick="downloadData()">å¯¼å‡º</button>
    <button onclick="saveAsImage()">ä¿å­˜ä¸ºå›¾ç‰‡</button>
    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importDataFromFile(event)">
    <label for="importFile" class="button">å¯¼å…¥æ•°æ®</label>
</div>

<!-- å³é”®èœå• -->
<div id="contextMenu" class="context-menu">
    <div class="context-menu-item" onclick="createNewMindMap()">
        <span class="menu-icon">ğŸ†•</span>
        <span>æ–°å»ºæ€ç»´å¯¼å›¾</span>
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" onclick="addNode()">
        <span class="menu-icon">â•</span>
        <span>æ·»åŠ å­èŠ‚ç‚¹</span>
    </div>
    <div class="context-menu-item" onclick="editNode()">
        <span class="menu-icon">âœï¸</span>
        <span>ç¼–è¾‘èŠ‚ç‚¹</span>
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" onclick="removeNode()">
        <span class="menu-icon">ğŸ—‘ï¸</span>
        <span>åˆ é™¤èŠ‚ç‚¹</span>
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" onclick="openLocalFile()">
        <span class="menu-icon">ğŸ“‚</span>
        <span>æ‰“å¼€æœ¬åœ°æ–‡ä»¶</span>
    </div>
    <div class="context-menu-item" onclick="saveToLocalFile()">
        <span class="menu-icon">ğŸ’¾</span>
        <span>ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶</span>
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" onclick="saveAsImage()">
        <span class="menu-icon">ğŸ“·</span>
        <span>ä¿å­˜ä¸ºå›¾ç‰‡</span>
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" onclick="generateShareURL()">
        <span class="menu-icon">ğŸ”—</span>
        <span>ç”Ÿæˆåˆ†äº«é“¾æ¥</span>
    </div>
</div>

<!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
<input type="file" id="openFile" accept=".json" style="display: none;" onchange="openLocalFileHandler(event)">
<a id="downloadLink" style="display: none;"></a>
<!-- æ€ç»´å¯¼å›¾å®¹å™¨ -->
<div id="jsmind_container"></div>

<script src="./jsmind/js-legacy/jsmind.js"></script>
<script src="./jsmind/js-legacy/jsmind.draggable-node.js"></script>
<script src="./jsmind/js-legacy/jsmind.screenshot.js"></script>
<script>
    // åˆå§‹åŒ–æ€ç»´å¯¼å›¾
    let jm = null;
    let contextMenu = null;
    let selectedNode = null;
    let currentFileName = null; // å½“å‰æ–‡ä»¶å
    let isModified = false; // æ˜¯å¦å·²ä¿®æ”¹
    
    const initMindMap = () => {
        const options = {
            container: 'jsmind_container',
            editable: true,
            theme: 'white',
        };

        // å°è¯•ä»URLå‚æ•°è·å–æ•°æ®ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤æ•°æ®
        let data = loadDataFromURL() || getDefaultMindMapData();
        
        jm = new jsMind(options);
        jm.show(data);
        
        // åˆå§‹åŒ–å³é”®èœå•å’Œäº‹ä»¶ç›‘å¬
        initContextMenu();
        initDoubleClickHandler();
        initModificationTracking();
        initMouseControls();
        
        // æ›´æ–°æ ‡é¢˜
        updateTitle();
    }
    
    // ä»URLå‚æ•°åŠ è½½æ•°æ®
    function loadDataFromURL() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const jsonParam = urlParams.get('data') || urlParams.get('json');
            
            if (jsonParam) {
                // URLè§£ç 
                const decodedJson = decodeURIComponent(jsonParam);
                const data = JSON.parse(decodedJson);
                
                // éªŒè¯æ•°æ®æ ¼å¼
                if (validateMindMapData(data)) {
                    // è®¾ç½®æ–‡ä»¶åï¼ˆå¦‚æœæœ‰meta.nameï¼‰
                    if (data.meta && data.meta.name) {
                        currentFileName = data.meta.name;
                    }
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    setTimeout(() => {
                        showZoomIndicator('ä»URLåŠ è½½æˆåŠŸ');
                    }, 500);
                    
                    return data;
                } else {
                    throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
            }
        } catch (error) {
            console.error('URLå‚æ•°è§£æå¤±è´¥:', error);
            
            // æ˜¾ç¤ºé”™è¯¯æç¤º
            setTimeout(() => {
                alert('JSONå­—ç¬¦ä¸²æœ‰è¯¯ï¼š' + error.message);
                showZoomIndicator('JSONè§£æå¤±è´¥');
            }, 500);
        }
        
        return null;
    }
    
    // éªŒè¯æ€ç»´å¯¼å›¾æ•°æ®æ ¼å¼
    function validateMindMapData(data) {
        // æ£€æŸ¥åŸºæœ¬ç»“æ„
        if (!data || typeof data !== 'object') {
            return false;
        }
        
        // æ£€æŸ¥å¿…éœ€å­—æ®µ
        if (!data.format || !data.data) {
            return false;
        }
        
        // æ£€æŸ¥æ ¹èŠ‚ç‚¹
        if (!data.data.id || !data.data.topic) {
            return false;
        }
        
        return true;
    }
    
    // è·å–é»˜è®¤æ€ç»´å¯¼å›¾æ•°æ®
    function getDefaultMindMapData() {
        return {
            "meta": {
                "name": "æ–°å»ºæ€ç»´å¯¼å›¾",
                "author": "user",
                "version": "1.0"
            },
            "format": "node_tree",
            "data": {
                "id": "root",
                "topic": "ä¸­å¿ƒä¸»é¢˜",
                "children": []
            }
        };
    }
    
    // æ›´æ–°é¡µé¢æ ‡é¢˜
    function updateTitle() {
        const fileName = currentFileName || "æ–°å»ºæ€ç»´å¯¼å›¾";
        const modified = isModified ? " *" : "";
        document.title = `${fileName}${modified} - åœ¨çº¿æ€ç»´å¯¼å›¾`;
    }
    
    // åˆå§‹åŒ–ä¿®æ”¹è·Ÿè¸ª
    function initModificationTracking() {
        // ç›‘å¬æ€ç»´å¯¼å›¾çš„ä¿®æ”¹äº‹ä»¶
        const container = document.getElementById('jsmind_container');
        
        // ä½¿ç”¨MutationObserverç›‘å¬DOMå˜åŒ–
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList' || mutation.type === 'attributes') {
                    markAsModified();
                }
            });
        });
        
        observer.observe(container, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'class']
        });
    }
    
    // æ ‡è®°ä¸ºå·²ä¿®æ”¹
    function markAsModified() {
        if (!isModified) {
            isModified = true;
            updateTitle();
        }
    }
    
    // æ ‡è®°ä¸ºæœªä¿®æ”¹
    function markAsUnmodified() {
        isModified = false;
        updateTitle();
    }

    // æ·»åŠ å­èŠ‚ç‚¹
    function addNode() {
        const targetNode = selectedNode || jm.get_selected_node();
        if (targetNode) {
            const nodeId = Date.now().toString();
            jm.add_node(targetNode.id, nodeId, 'æ–°å¢å­èŠ‚ç‚¹', {});
            markAsModified();
            hideContextMenu();
        }
    }

    // åˆ é™¤èŠ‚ç‚¹
    function removeNode() {
        const targetNode = selectedNode || jm.get_selected_node();
        if (targetNode && targetNode.id !== 'root') {
            jm.remove_node(targetNode);
            markAsModified();
            hideContextMenu();
        }
    }

    // ç¼–è¾‘èŠ‚ç‚¹
    function editNode() {
        const targetNode = selectedNode || jm.get_selected_node();
        if (targetNode) {
            const newText = prompt('è¾“å…¥æ–°å†…å®¹', targetNode.topic);
            if (newText && newText !== targetNode.topic) {
                jm.update_node(targetNode.id, newText);
                markAsModified();
            }
            hideContextMenu();
        }
    }
    
    // æ–°å»ºæ€ç»´å¯¼å›¾
    function createNewMindMap() {
        if (isModified) {
            const confirmed = confirm("å½“å‰æ€ç»´å¯¼å›¾å·²ä¿®æ”¹ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ");
            if (confirmed) {
                saveToLocalFile();
                return; // ç”¨æˆ·å¯èƒ½å–æ¶ˆäº†ä¿å­˜ï¼Œä¸ç»§ç»­æ–°å»º
            }
        }
        
        const data = getDefaultMindMapData();
        jm.show(data);
        currentFileName = null;
        markAsUnmodified();
        hideContextMenu();
        
        // æç¤ºç”¨æˆ·
        setTimeout(() => {
            alert("æ–°å»ºæ€ç»´å¯¼å›¾æˆåŠŸï¼");
        }, 100);
    }
    
    // æ‰“å¼€æœ¬åœ°æ–‡ä»¶
    function openLocalFile() {
        if (isModified) {
            const confirmed = confirm("å½“å‰æ€ç»´å¯¼å›¾å·²ä¿®æ”¹ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ");
            if (confirmed) {
                saveToLocalFile();
                return; // ç”¨æˆ·å¯èƒ½å–æ¶ˆäº†ä¿å­˜ï¼Œä¸ç»§ç»­æ‰“å¼€
            }
        }
        
        document.getElementById('openFile').click();
        hideContextMenu();
    }
    
    // å¤„ç†æ‰“å¼€æœ¬åœ°æ–‡ä»¶
    function openLocalFileHandler(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const mindData = JSON.parse(e.target.result);
                jm.show(mindData);
                currentFileName = file.name.replace('.json', '');
                markAsUnmodified();
                alert("æ–‡ä»¶æ‰“å¼€æˆåŠŸï¼");
            } catch (error) {
                alert("æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é€‰æ‹©æœ‰æ•ˆçš„JSONæ–‡ä»¶ã€‚");
                console.error("è§£ææ–‡ä»¶å¤±è´¥:", error);
            }
        };
        reader.readAsText(file);
        
        // æ¸…ç©ºinputå€¼ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
        event.target.value = '';
    }
    
    // ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶
    function saveToLocalFile() {
        const mindData = jm.get_data();
        const dataStr = JSON.stringify(mindData, null, 2);
        const blob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        
        const downloadLink = document.getElementById('downloadLink');
        const fileName = currentFileName || 'æ€ç»´å¯¼å›¾';
        downloadLink.href = url;
        downloadLink.download = `${fileName}.json`;
        downloadLink.click();
        
        // æ¸…ç†URLå¯¹è±¡
        setTimeout(() => {
            URL.revokeObjectURL(url);
        }, 100);
        
        // å¦‚æœæ˜¯æ–°æ–‡ä»¶ï¼Œè®¾ç½®æ–‡ä»¶å
        if (!currentFileName) {
            currentFileName = fileName;
        }
        
        markAsUnmodified();
        hideContextMenu();
        
        // æç¤ºç”¨æˆ·
        setTimeout(() => {
            alert("æ–‡ä»¶ä¿å­˜æˆåŠŸï¼");
        }, 100);
    }
    
    // ç”Ÿæˆåˆ†äº«é“¾æ¥
    function generateShareURL() {
        try {
            const mindData = jm.get_data();
            const jsonString = JSON.stringify(mindData);
            const encodedJson = encodeURIComponent(jsonString);
            
            // æ„å»ºåˆ†äº«URL
            const baseURL = window.location.origin + window.location.pathname;
            const shareURL = `${baseURL}?data=${encodedJson}`;
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(shareURL).then(() => {
                    alert('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼å…¶ä»–äººå¯ä»¥é€šè¿‡æ­¤é“¾æ¥ç›´æ¥æŸ¥çœ‹æ‚¨çš„æ€ç»´å¯¼å›¾ã€‚');
                }).catch(() => {
                    showShareURLDialog(shareURL);
                });
            } else {
                showShareURLDialog(shareURL);
            }
            
            hideContextMenu();
        } catch (error) {
            alert('ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥ï¼š' + error.message);
        }
    }
    
    // æ˜¾ç¤ºåˆ†äº«é“¾æ¥å¯¹è¯æ¡†
    function showShareURLDialog(url) {
        const dialog = prompt('åˆ†äº«é“¾æ¥å·²ç”Ÿæˆï¼Œè¯·å¤åˆ¶ï¼š', url);
        if (dialog !== null) {
            alert('è¯·æ‰‹åŠ¨å¤åˆ¶ä¸Šé¢çš„é“¾æ¥è¿›è¡Œåˆ†äº«ã€‚');
        }
    }
    
    function saveAsImage() {
        // ä¿å­˜åŸå§‹çš„æ°´å°å‡½æ•°
        const originalWatermark = jm.screenshot._watermark;
        
        // ä¸´æ—¶æ›¿æ¢æ°´å°å‡½æ•°ï¼Œä½¿ç”¨è‡ªå®šä¹‰æ–‡æœ¬
        jm.screenshot._watermark = function() {
            var c = this.canvas_elem;
            var ctx = this.canvas_ctx;
            ctx.textAlign = 'right';
            ctx.textBaseline = 'bottom';
            ctx.fillStyle = '#000';
            ctx.font = '11px Verdana,Arial,Helvetica,sans-serif';
            
            // ä½¿ç”¨è‡ªå®šä¹‰æ–‡æœ¬æ›¿ä»£åŸæ¥çš„URL
            ctx.fillText('1_bit', c.width - 5.5, c.height - 2.5);
            
            // å·¦ä¸‹è§’ä¹Ÿå¯ä»¥æ˜¾ç¤ºè‡ªå®šä¹‰æ–‡æœ¬ï¼Œæˆ–è€…ç•™ç©º
            ctx.textAlign = 'left';
            // ctx.fillText('1_bit', 5.5, c.height - 2.5); // å¦‚æœéœ€è¦å·¦ä¸‹è§’ä¹Ÿæ˜¾ç¤º
        };
        
        // æ‰§è¡Œæˆªå›¾
        jm.screenshot.shootDownload();
        
        // æ¢å¤åŸå§‹çš„æ°´å°å‡½æ•°
        jm.screenshot._watermark = originalWatermark;
        
        hideContextMenu();
    }

    // åˆå§‹åŒ–å³é”®èœå•
    function initContextMenu() {
        contextMenu = document.getElementById('contextMenu');
        const container = document.getElementById('jsmind_container');
        
        // å³é”®èœå•äº‹ä»¶
        container.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            
            // è·å–ç‚¹å‡»çš„èŠ‚ç‚¹
            const clickedElement = e.target.closest('jmnode');
            if (clickedElement) {
                const nodeId = clickedElement.getAttribute('nodeid');
                selectedNode = jm.get_node(nodeId);
                jm.select_node(selectedNode);
            } else {
                selectedNode = null;
            }
            
            // æ˜¾ç¤ºå³é”®èœå•
            showContextMenu(e.clientX, e.clientY);
        });
        
        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—èœå•
        document.addEventListener('click', function(e) {
            if (!contextMenu.contains(e.target)) {
                hideContextMenu();
            }
        });
        
        // æ»šåŠ¨æ—¶éšè—èœå•
        window.addEventListener('scroll', hideContextMenu);
        window.addEventListener('resize', hideContextMenu);
    }
    
    // æ˜¾ç¤ºå³é”®èœå•
    function showContextMenu(x, y) {
        contextMenu.style.display = 'block';
        contextMenu.style.left = x + 'px';
        contextMenu.style.top = y + 'px';
        
        // ç¡®ä¿èœå•ä¸ä¼šè¶…å‡ºå±å¹•
        const rect = contextMenu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
            contextMenu.style.left = (x - rect.width) + 'px';
        }
        if (rect.bottom > window.innerHeight) {
            contextMenu.style.top = (y - rect.height) + 'px';
        }
        
        // æ ¹æ®æ˜¯å¦é€‰ä¸­èŠ‚ç‚¹æ¥å¯ç”¨/ç¦ç”¨èœå•é¡¹
        updateContextMenuItems();
    }
    
    // éšè—å³é”®èœå•
    function hideContextMenu() {
        contextMenu.style.display = 'none';
    }
    
    // æ›´æ–°å³é”®èœå•é¡¹çŠ¶æ€
    function updateContextMenuItems() {
        const menuItems = contextMenu.querySelectorAll('.context-menu-item');
        const hasSelectedNode = selectedNode !== null;
        const isRootNode = selectedNode && selectedNode.id === 'root';
        
        // æ–°å»ºæ€ç»´å¯¼å›¾ - å§‹ç»ˆå¯ç”¨
        // menuItems[0] - æ–°å»ºæ€ç»´å¯¼å›¾
        
        // æ·»åŠ å­èŠ‚ç‚¹ - éœ€è¦é€‰ä¸­èŠ‚ç‚¹
        menuItems[2].classList.toggle('disabled', !hasSelectedNode);
        
        // ç¼–è¾‘èŠ‚ç‚¹ - éœ€è¦é€‰ä¸­èŠ‚ç‚¹
        menuItems[3].classList.toggle('disabled', !hasSelectedNode);
        
        // åˆ é™¤èŠ‚ç‚¹ - éœ€è¦é€‰ä¸­èŠ‚ç‚¹ä¸”ä¸æ˜¯æ ¹èŠ‚ç‚¹
        menuItems[5].classList.toggle('disabled', !hasSelectedNode || isRootNode);
        
        // å…¶ä»–åŠŸèƒ½é¡¹å§‹ç»ˆå¯ç”¨
        // menuItems[7] - æ‰“å¼€æœ¬åœ°æ–‡ä»¶
        // menuItems[8] - ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶
        // menuItems[10] - ä¿å­˜ä¸ºå›¾ç‰‡
    }
    
    // åˆå§‹åŒ–åŒå‡»äº‹ä»¶å¤„ç†
    function initDoubleClickHandler() {
        const container = document.getElementById('jsmind_container');
        
        container.addEventListener('dblclick', function(e) {
            const clickedElement = e.target.closest('jmnode');
            if (clickedElement) {
                const nodeId = clickedElement.getAttribute('nodeid');
                const node = jm.get_node(nodeId);
                jm.select_node(node);
                selectedNode = node;
                
                // åŒå‡»èŠ‚ç‚¹æ—¶æ·»åŠ å­èŠ‚ç‚¹
                addNode();
            } else {
                // åŒå‡»ç©ºç™½åŒºåŸŸé‡ç½®è§†å›¾
                setTimeout(() => {
                    const nodesContainer = container.querySelector('jmnodes');
                    const canvasElements = container.querySelectorAll('canvas');
                    
                    if (nodesContainer) {
                        const resetTransform = 'translate(0px, 0px) scale(1)';
                        nodesContainer.style.transform = resetTransform;
                        canvasElements.forEach(canvas => {
                            canvas.style.transform = resetTransform;
                        });
                        showZoomIndicator('é‡ç½®è§†å›¾');
                    }
                }, 10);
            }
        });
    }

    // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', function(e) {
        // Ctrl+N æ–°å»º
        if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            createNewMindMap();
        }
        // Ctrl+O æ‰“å¼€
        else if (e.ctrlKey && e.key === 'o') {
            e.preventDefault();
            openLocalFile();
        }
        // Ctrl+S ä¿å­˜
        else if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveToLocalFile();
        }
    });
    
    // é¡µé¢å…³é—­å‰æé†’ä¿å­˜
    window.addEventListener('beforeunload', function(e) {
        if (isModified) {
            e.preventDefault();
            e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
            return e.returnValue;
        }
    });

    // åˆå§‹åŒ–é¼ æ ‡æ§åˆ¶åŠŸèƒ½
    function initMouseControls() {
        const container = document.getElementById('jsmind_container');
        let scale = 1;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let containerStartX = 0;
        let containerStartY = 0;
        
        // ç­‰å¾…jsMindå®Œå…¨åˆå§‹åŒ–
        setTimeout(() => {
            // è·å–æ€ç»´å¯¼å›¾çš„èŠ‚ç‚¹å®¹å™¨
            const nodesContainer = container.querySelector('jmnodes');
            const canvasElements = container.querySelectorAll('canvas');
            
            if (!nodesContainer) return;
            
            // è®¾ç½®åˆå§‹æ ·å¼ - åªå¯¹èŠ‚ç‚¹å®¹å™¨å’Œç”»å¸ƒè¿›è¡Œå˜æ¢
            nodesContainer.style.transformOrigin = 'center center';
            nodesContainer.style.transition = 'transform 0.1s ease-out';
            
            canvasElements.forEach(canvas => {
                canvas.style.transformOrigin = 'center center';
                canvas.style.transition = 'transform 0.1s ease-out';
            });
            
            // é¼ æ ‡æ»šè½®ç¼©æ”¾åŠŸèƒ½
            container.addEventListener('wheel', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const newScale = Math.max(0.3, Math.min(3, scale + delta));
                
                if (newScale !== scale) {
                    scale = newScale;
                    
                    // åªç¼©æ”¾èŠ‚ç‚¹å®¹å™¨å’Œç”»å¸ƒï¼Œä¸ç¼©æ”¾æ•´ä¸ªå®¹å™¨
                    const transform = `translate(${containerStartX}px, ${containerStartY}px) scale(${scale})`;
                    nodesContainer.style.transform = transform;
                    canvasElements.forEach(canvas => {
                        canvas.style.transform = transform;
                    });
                    
                    // æ˜¾ç¤ºç¼©æ”¾æç¤º
                    showZoomIndicator(Math.round(scale * 100) + '%');
                }
            }, { passive: false });
            
            // é¼ æ ‡ä¸­é”®æŒ‰ä¸‹å¼€å§‹æ‹–æ‹½
            container.addEventListener('mousedown', function(e) {
                if (e.button === 1) { // ä¸­é”®
                    e.preventDefault();
                    isDragging = true;
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                    
                    // æ”¹å˜é¼ æ ‡æ ·å¼
                    container.style.cursor = 'grabbing';
                    nodesContainer.style.transition = 'none';
                    canvasElements.forEach(canvas => {
                        canvas.style.transition = 'none';
                    });
                }
            });
            
            // é¼ æ ‡ç§»åŠ¨æ—¶æ‹–æ‹½
            container.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    const deltaX = e.clientX - dragStartX;
                    const deltaY = e.clientY - dragStartY;
                    
                    const newX = containerStartX + deltaX;
                    const newY = containerStartY + deltaY;
                    
                    const transform = `translate(${newX}px, ${newY}px) scale(${scale})`;
                    nodesContainer.style.transform = transform;
                    canvasElements.forEach(canvas => {
                        canvas.style.transform = transform;
                    });
                }
            });
            
            // é¼ æ ‡é‡Šæ”¾ç»“æŸæ‹–æ‹½
            container.addEventListener('mouseup', function(e) {
                if (e.button === 1 && isDragging) {
                    isDragging = false;
                    
                    // æ›´æ–°ä½ç½®çŠ¶æ€
                    const deltaX = e.clientX - dragStartX;
                    const deltaY = e.clientY - dragStartY;
                    containerStartX += deltaX;
                    containerStartY += deltaY;
                    
                    container.style.cursor = 'default';
                    nodesContainer.style.transition = 'transform 0.1s ease-out';
                    canvasElements.forEach(canvas => {
                        canvas.style.transition = 'transform 0.1s ease-out';
                    });
                }
            });
            
            // é˜²æ­¢ä¸­é”®ç‚¹å‡»çš„é»˜è®¤è¡Œä¸ºï¼ˆå¦‚æ‰“å¼€é“¾æ¥ï¼‰
            container.addEventListener('auxclick', function(e) {
                if (e.button === 1) {
                    e.preventDefault();
                }
            });
            
            // é¼ æ ‡ç¦»å¼€å®¹å™¨æ—¶ç»“æŸæ‹–æ‹½
            container.addEventListener('mouseleave', function(e) {
                if (isDragging) {
                    isDragging = false;
                    container.style.cursor = 'default';
                    nodesContainer.style.transition = 'transform 0.1s ease-out';
                    canvasElements.forEach(canvas => {
                        canvas.style.transition = 'transform 0.1s ease-out';
                    });
                }
            });
            
        }, 100); // å»¶è¿Ÿ100msç¡®ä¿jsMindå®Œå…¨åˆå§‹åŒ–
    }
    
    // æ˜¾ç¤ºç¼©æ”¾æŒ‡ç¤ºå™¨
    function showZoomIndicator(text) {
        // ç§»é™¤å·²å­˜åœ¨çš„æŒ‡ç¤ºå™¨
        const existingIndicator = document.getElementById('zoomIndicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }
        
        // åˆ›å»ºæ–°çš„æŒ‡ç¤ºå™¨
        const indicator = document.createElement('div');
        indicator.id = 'zoomIndicator';
        indicator.textContent = text;
        indicator.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            z-index: 10001;
            pointer-events: none;
            opacity: 1;
            transition: opacity 0.3s ease;
        `;
        
        document.body.appendChild(indicator);
        
        // 1ç§’åæ·¡å‡ºå¹¶ç§»é™¤
        setTimeout(() => {
            indicator.style.opacity = '0';
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 300);
        }, 1000);
    }

    // åˆå§‹åŒ–
    window.onload = initMindMap;
</script>
</body>
</html>
